#!/bin/bash
#
# cldyo - Run Claude Code in an isolated Apple container (VM)
#
# Usage:
#   cldyo              # Start claude --dangerously-skip-permissions in current dir
#   cldyo -c           # Continue last conversation
#   cldyo -n 3         # Start 3 parallel instances in separate terminals
#   cldyo "prompt"     # Start with initial prompt
#
# The container provides full VM isolation while sharing your project directory.
# Your host 'claude' command remains completely unaffected.
#

set -e

# Configuration
CONTAINER_IMAGE="cldyo-claude:latest"
INSTANCE_PREFIX="cldyo"
DEFAULT_MEMORY="4G"
DEFAULT_CPUS="2"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Parse arguments
NUM_INSTANCES=1
CLAUDE_ARGS=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -n|--num)
            NUM_INSTANCES="$2"
            shift 2
            ;;
        --help|-h)
            echo "cldyo - Run Claude Code in isolated VM containers"
            echo ""
            echo "Usage:"
            echo "  cldyo [options] [claude-args...]"
            echo ""
            echo "Options:"
            echo "  -n, --num N     Start N parallel instances in separate terminals"
            echo "  -h, --help      Show this help"
            echo ""
            echo "Examples:"
            echo "  cldyo                    # Interactive claude with dangerous perms"
            echo "  cldyo -c                 # Continue last conversation"
            echo "  cldyo -n 4               # Start 4 parallel instances"
            echo "  cldyo 'build the app'    # Start with a prompt"
            echo ""
            echo "Environment:"
            echo "  ANTHROPIC_API_KEY is passed through to the container"
            echo "  CLDYO_MEMORY      Memory limit (default: 4G)"
            echo "  CLDYO_CPUS        CPU limit (default: 2)"
            exit 0
            ;;
        *)
            CLAUDE_ARGS="$CLAUDE_ARGS $1"
            shift
            ;;
    esac
done

# Get current directory for mounting
WORKSPACE_DIR="$(pwd)"
WORKSPACE_NAME="$(basename "$WORKSPACE_DIR")"

# Check if container CLI is available
if ! command -v container &> /dev/null; then
    echo -e "${RED}Error: Apple 'container' CLI not found${NC}"
    echo "Install it from: https://github.com/apple/container/releases"
    exit 1
fi

# Check if container service is running
if ! container system status &> /dev/null 2>&1; then
    echo -e "${YELLOW}Starting container service...${NC}"
    container system start
    sleep 2
fi

# Check if our image exists
if ! container image list 2>/dev/null | grep -q "cldyo-claude"; then
    echo -e "${RED}Error: cldyo-claude image not found${NC}"
    echo "Build it with: container build -t cldyo-claude:latest <path-to-Containerfile>"
    exit 1
fi

# Check for API key
if [[ -z "$ANTHROPIC_API_KEY" ]]; then
    echo -e "${YELLOW}Warning: ANTHROPIC_API_KEY not set${NC}"
fi

# Resource configuration
MEMORY="${CLDYO_MEMORY:-$DEFAULT_MEMORY}"
CPUS="${CLDYO_CPUS:-$DEFAULT_CPUS}"

# Function to run a single instance
run_instance() {
    local instance_num=$1
    local instance_name="${INSTANCE_PREFIX}-${WORKSPACE_NAME}-$$-${instance_num}"

    if [[ $NUM_INSTANCES -gt 1 ]]; then
        echo -e "${BLUE}Starting instance $instance_num...${NC}"
    fi

    # Build environment arguments
    ENV_ARGS=""
    if [[ -n "$ANTHROPIC_API_KEY" ]]; then
        ENV_ARGS="-e ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY"
    fi

    # Run container with workspace mounted
    container run \
        --name "$instance_name" \
        --rm \
        -t -i \
        -m "$MEMORY" \
        -c "$CPUS" \
        $ENV_ARGS \
        -v "$WORKSPACE_DIR:/workspace" \
        -w /workspace \
        "$CONTAINER_IMAGE" \
        claude --dangerously-skip-permissions $CLAUDE_ARGS
}

# Main execution
if [[ $NUM_INSTANCES -eq 1 ]]; then
    # Single instance - run interactively
    run_instance 1
else
    # Multiple instances - run in parallel using separate terminal windows
    echo -e "${GREEN}Starting $NUM_INSTANCES parallel Claude instances...${NC}"
    echo -e "${YELLOW}Each instance runs in its own isolated VM${NC}"
    echo ""

    for i in $(seq 1 $NUM_INSTANCES); do
        # Open new Terminal window and run cldyo there
        osascript <<EOF
tell application "Terminal"
    activate
    do script "cd '$WORKSPACE_DIR' && ANTHROPIC_API_KEY='$ANTHROPIC_API_KEY' cldyo $CLAUDE_ARGS"
end tell
EOF
        sleep 0.5
    done

    echo -e "${GREEN}Launched $NUM_INSTANCES instances in separate Terminal windows${NC}"
    echo ""
    echo "Each instance has:"
    echo "  - Isolated VM environment (full process isolation)"
    echo "  - Shared access to: $WORKSPACE_DIR"
    echo "  - Full --dangerously-skip-permissions mode"
    echo "  - ${MEMORY} memory, ${CPUS} CPUs"
fi
